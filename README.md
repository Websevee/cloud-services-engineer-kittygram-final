# Проект Kittygram

## Демонстрационный стенд
Url: http://62.84.112.117/

Login: admin

Password: _password123

## Настройка и развертывание

### 1. Секреты GitHub

Необходимо настроить следующие secrets в вашем репозитории GitHub:

#### DJANGO
*   `SECRET_KEY`: Секретный ключ (пример в файле `_env.example`)

#### База данных
*   `DB_ENGINE`: Движок базы данных. (например, `django.db.backends.postgresql`)
*   `DB_HOST`: Хост базы данных (пример в файле `_env.example`)
*   `DB_PORT`: Порт базы данных (пример в файле `_env.example`)
*   `POSTGRES_DB`: Имя базы данных PostgreSQL (пример в файле `_env.example`)
*   `POSTGRES_USER`: Имя пользователя PostgreSQL (пример в файле `_env.example`)
*   `POSTGRES_PASSWORD`: Пароль пользователя PostgreSQL (пример в файле `_env.example`)

#### DockerHub
*   `DOCKERHUB_USERNAME`: Ваше имя пользователя DockerHub.
*   `DOCKERHUB_PASSWORD`: Ваш пароль DockerHub (или токен доступа).

#### Данные сервера
*   `SERVER_HOST`: IP-адрес удаленного сервера (VM) для развертывания (необходимо заранее его получить на Yandex Cloud)
*   `SERVER_USER`: Имя пользователя для SSH-подключения (например, `user`)
*   `SERVER_SSH_PRIVATE_KEY`: **Приватный** SSH-ключ для аутентификации на сервере развертывания. Убедитесь, что этот ключ правильно отформатирован (например, начинается с `-----BEGIN OPENSSH PRIVATE KEY-----` и заканчивается `-----END OPENSSH PRIVATE KEY-----`).
*   `SERVER_SSH_PUBLIC_KEY`: **Публичный** SSH-ключ, связанный с вашим приватным ключом, используемый Terraform для настройки сервера. (например, начинается с `ssh-rsa AAAA...`)

#### Yandex Cloud и Terraform
*   `YANDEX_CLOUD_ID`: Идентификатор облака на Yandex Cloud.
*   `YANDEX_FOLDER_ID`: Идентификатор каталога в облаке на Yandex Cloud.
*   `YC_KEY_JSON`: Ключ сервисного аккаунта Yandex Cloud в формате JSON. Должен быть в кодировке base64. Вы можете сгенерировать его в Yandex Cloud IAM.
*   `S3_ACCESS_KEY`: Ключ доступа для S3-бакета, используемого в качестве хранилища состояния бэкенда Terraform.
*   `S3_SECRET_KEY`: Секретный ключ для S3-бакета, используемого в качестве хранилища состояния бэкенда Terraform.

#### Telegram (не обязательно)
*   `TELEGRAM_TO`: Идентификатор вашего чата Telegram, куда будут отправляться уведомления о развертывании.
*   `TELEGRAM_TOKEN`: Токен вашего бота Telegram.

### 2. Переменные GitHub

Необходимо настроить следующие vars в вашем репозитории GitHub:

*   `ALLOWED_HOSTS`: Список разрешенных хостов для вашего приложения Django, разделенных запятыми (например `'*'`)

### 3. Запуск Terraform

Рабочий процесс `terraform.yml` используется для управления вашей инфраструктурой в Yandex Cloud. Его можно запустить вручную на вкладке GitHub Actions.

При запуске рабочего процесса вы можете выбрать одно из следующих действий:
*   `plan`: Чтобы увидеть, какие изменения внесет Terraform, не применяя их.
*   `apply`: Чтобы создать или обновить инфраструктуру, как определено в конфигурации Terraform.
*   `destroy`: Чтобы удалить всю управляемую инфраструктуру.

Действие `apply` также автоматически запустит рабочий процесс развертывания после успешного развертывания инфраструктуры.

### 4. Запуск развертывания

Рабочий процесс `deploy.yml` вызывается рабочим процессом `terraform.yml`. Его также можно запустить вручную при необходимости, передав входной параметр `server_host`.

Этот рабочий процесс выполняет следующие шаги:
1.  Запускает тесты бэкенда и фронтенда.
2.  Собирает образы Docker для бэкенда, фронтенда и шлюза NGINX.
3.  Отправляет эти образы в DockerHub.
4.  Копирует `docker-compose.production.yml` и создает файл `.env` на удаленном сервере.
5.  Развертывает приложение с использованием Docker Compose на удаленном сервере.
6.  Выполняет миграции Django и собирает статические файлы.
7.  Запускает автоматические тесты для развернутого приложения.
8.  Отправляет уведомление в Telegram о статусе развертывания.
